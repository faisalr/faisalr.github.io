<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="style.css" />
    <script src="astro.js"></script>
</head>

<body>
    <h1 style="font-weight: bolder">Astronomy Engine</h1>

    <img id="pic" style="float:right" src="img/0502.jpg" width="500" height="500" />

    <table cellspacing="0" id="CalcTable">
        <tbody>
            <tr>
                <th>Variable</th>
                <th>Value</th>
            </tr>

            <tr>
                <td>Date</td>
                <td><input onchange="ChangeDate()" type="date" id="dateAndTime"></td>
            </tr>

            <tr>
                <td>Latitude</td>
                <td> <input onchange="ChangeDate()" type="number" id="latitude" min="-90" max="90">
                </td>
            </tr>

            <tr>
                <td>Longitude</td>
                <td> <input onchange="ChangeDate()" type="number" id="longitude" min="-180" max="180">
                </td>
            </tr>

            <tr>
                <td>Phase</td>
                <td id="MoonPhaseAngle" class="Numeric"> <span id="MoonPhaseAngle">?</span>°</td>
            </tr>

            <tr>
                <td>Moonrise</td>
                <td id="Moonrise" class="Numeric">?</td>
            </tr>
            <tr>
                <td>Moonset</td>
                <td id="Moonset" class="Numeric">?</td>
            </tr>

            <tr>
                <td>Azimuth</td>
                <td id="Moon_az" class="Numeric">?</td>
            </tr>

            <tr>
                <td>Altitude</td>
                <td id="Moon_alt" class="Numeric">?</td>
            </tr>

            <tr>
                <td>Right Ascension</td>
                <td id="Moon_ra" class="Numeric">?</td>
            </tr>
            <tr>
                <td>Declination</td>
                <td id="Moon_dec" class="Numeric">?</td>
            </tr>

        </tbody>
    </table>

    </div>
    <footer>
    </footer>

    <script>

        navigator.geolocation.getCurrentPosition(function (location) {
            console.log(location.coords.latitude);
            console.log(location.coords.longitude);
            console.log(location.coords.accuracy);
            let latText = document.getElementById("latitude");
            let longText = document.getElementById("longitude");
            latText.value = location.coords.latitude;
            longText.value = location.coords.longitude;
        });

        function FormatCoord(x) {
            return x.toFixed(2);
        }

        function ChangeDate()
        {
            console.log(document.getElementById('dateAndTime').value);
            Update(new Date(document.getElementById('dateAndTime').value))
        }

        function Pad(s, w) {
            s = s.toFixed(0);
            while (s.length < w) {
                s = '0' + s;
            }
            return s;
        }

        function FormatDate(date) {
            var year = Pad(date.getFullYear(), 4);
            var month = Pad(1 + date.getMonth(), 2);
            var day = Pad(date.getDate(), 2);
            var hour = Pad(date.getHours(), 2);
            var minute = Pad(date.getMinutes(), 2);
            var second = Pad(date.getSeconds(), 2);
            return `${year}-${month}-${day} ${hour}:${minute}:${second}`;
        }

        function Update(now) {
            var phase = Astronomy.MoonPhase(now);
            var x = Math.trunc((phase * 2) + 502);
            var z = String(x).padStart(4, '0');
            var img = "https://svs.gsfc.nasa.gov/vis/a000000/a005000/a005048/frames/730x730_1x1_30p/moon." + z + ".jpg";

            let observer = new Astronomy.Observer(33, 33, 0);
            let equ_2000 = Astronomy.Equator(Astronomy.Body.Moon, now, observer, false, true);
            let equ_ofdate = Astronomy.Equator(Astronomy.Body.Moon, now, observer, true, true);
            let hor = Astronomy.Horizon(now, observer, equ_ofdate.ra, equ_ofdate.dec, 'normal');
            let moonrise = Astronomy.SearchRiseSet('Moon', observer, +1, now, 300);
            let moonset = Astronomy.SearchRiseSet('Moon', observer, -1, now, 300);
            document.getElementById('Moon_ra').innerText = FormatCoord(equ_2000.ra);
            document.getElementById('Moon_dec').innerText = FormatCoord(equ_2000.dec);
            document.getElementById('Moon_az').innerText = FormatCoord(hor.azimuth);
            document.getElementById('Moon_alt').innerText = FormatCoord(hor.altitude);
            document.getElementById('Moonrise').innerText = FormatDate(moonrise.date);
            document.getElementById('Moonset').innerText = FormatDate(moonset.date);
            var current = now.toISOString().substring(0, 10);
            document.getElementById('dateAndTime').value = current;
            document.getElementById('MoonPhaseAngle').innerText = phase.toFixed(3) + "°";
            document.getElementById('pic').src = img;
            console.log(document.getElementById('dateAndTime').value);
        }

        var d = new Date();
        Update(d);
    </script>
</body>

</html>